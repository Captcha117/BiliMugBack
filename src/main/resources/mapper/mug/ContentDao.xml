<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.oken1.modules.mug.dao.ContentDao">
    <select id="gameContent" resultType="map">
        select
            upper( replace ( uuid( ), "-", "" ) ) pk_id,
            r.aid aid,
            'G' type,
            r.game_id content_id,
            r.keyword keyword,
            current_timestamp() update_time
        from
            (
            select
                v.aid,
                v.title,
                z.*,
                row_number ( ) over ( PARTITION by v.aid order by v.aid, z.filter_index, z.keyword_index ) row_num
            from
                mug_video v
                join (
                select
                    g.game_id,
                    g.common_name,
                    g.filter_index,
                    k.keyword,
                    k.keyword_index
                from
                    mug_game g
                    join mug_game_keyword k on g.game_id = k.game_id
                order by
                    g.filter_index,
                    k.keyword_index
                ) z on instr( REPLACE ( v.title, ' ', '' ), z.keyword ) > 0
            where
                v.aid not in ( select c.aid from mug_video_content c where c.type = 'G' )
                and date(from_unixtime( v.pub_time )) >= str_to_date(#{startDate},'%Y-%m-%d')
                <if test="endDate!=null">
                     and str_to_date(#{endDate}, '%Y-%m-%d') >= date(from_unixtime( v.pub_time ))
                </if>
            ) r
        where
            r.row_num = 1
    </select>

    <select id="osuContent" resultType="map">
        SELECT
            upper( REPLACE ( uuid( ), "-", "" ) ) pk_id,
            v.aid aid,
            'G' type,
            '351D8F969DF84121B0A535C8ADFCC3CF' content_id,
            CURRENT_TIMESTAMP ( ) update_time
        FROM
            mug_video v
        WHERE
            instr( v.title, "|" ) > 0
            AND instr( v.title, "%" ) > 0
            AND v.aid NOT IN ( SELECT c.aid FROM mug_video_content c WHERE c.type = 'G' )
            AND date(from_unixtime( v.pub_time )) >= str_to_date(#{startDate},'%Y-%m-%d')
            <if test="endDate!=null">
                and str_to_date(#{endDate}, '%Y-%m-%d') >= date(from_unixtime( v.pub_time ))
            </if>
    </select>

    <insert id="insertGameContent">
        insert mug_video_content ( pk_id, aid, type, content_id, keyword, update_time ) select
        upper( replace ( uuid( ), "-", "" ) ) pk_id,
        r.aid aid,
        'G' type,
        r.game_id content_id,
        r.keyword keyword,
        current_timestamp ( ) update_time
        from
            (
            select
                v.aid,
                v.title,
                z.*,
                row_number ( ) over ( PARTITION by v.aid order by v.aid, z.filter_index, z.keyword_index ) row_num
            from
                mug_video v
                join (
                select
                    g.game_id,
                    g.common_name,
                    g.filter_index,
                    k.keyword,
                    k.keyword_index
                from
                    mug_game g
                    join mug_game_keyword k on g.game_id = k.game_id
                order by
                    g.filter_index,
                    k.keyword_index
                ) z on instr( REPLACE ( v.title, ' ', '' ), z.keyword ) > 0
            where
                v.aid not in ( select c.aid from mug_video_content c where c.type = 'G' )
                and date(from_unixtime( v.pub_time )) >= str_to_date(#{startDate},'%Y-%m-%d')
                <if test="endDate!=null">
                    and str_to_date(#{endDate}, '%Y-%m-%d') >= date(from_unixtime( v.pub_time ))
                </if>
            ) r
        where
            r.row_num = 1
    </insert>

    <insert id="insertOsuContent">
        insert mug_video_content ( pk_id, aid, type, content_id, keyword, update_time ) SELECT
            upper( REPLACE ( uuid( ), "-", "" ) ) pk_id,
            v.aid aid,
            'G' type,
            '351D8F969DF84121B0A535C8ADFCC3CF' content_id,
            '|' keyword,
            CURRENT_TIMESTAMP ( ) update_time
        FROM
            mug_video v
        WHERE
            instr( v.title, "|" ) > 0
            AND instr( v.title, "%" ) > 0
            AND v.aid NOT IN ( SELECT c.aid FROM mug_video_content c WHERE c.type = 'G' )
            AND date(from_unixtime( v.pub_time )) >= str_to_date(#{startDate},'%Y-%m-%d')
            <if test="endDate!=null">
                and str_to_date(#{endDate}, '%Y-%m-%d') >= date(from_unixtime( v.pub_time ))
            </if>
    </insert>

    <select id="findContent" resultType="io.oken1.modules.mug.entity.ContentEntity">
        select * from mug_video_content c where c.aid = #{aid} and c.content_id = #{contentId}
    </select>
</mapper>