<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.oken1.modules.mug.dao.GameDao">
    <!--游戏列表-->
    <select id="getGameList" resultType="map">
        SELECT g.game_id      GameId,
               g.common_name  CommonName,
               g.other_name   OtherName,
               g.icon_id      IconId,
               g.icon_version IconVersion
        FROM mug_game g
        where g.parent_id is null
        ORDER BY g.common_name
    </select>

    <!--游戏信息-->
    <select id="getGameInfoByGameId" resultType="java.util.LinkedHashMap">
        SELECT g.game_id                                         GameId,
               g.common_name                                     CommonName,
               left(g.other_name, LOCATE(',', g.other_name) - 1) OtherName,
               g.icon_version                                    IconVersion,
               c.company_name                                    Developer
        FROM mug_game g
                 LEFT JOIN mug_company c ON g.developer = c.company_id
        WHERE g.game_id = #{gameId}
    </select>

    <select id="getGamePlayData" resultType="map">
        SELECT
        <choose>
            <when test='type == "D"'>
                DATE_FORMAT( v.pub_date, '%m月%d日' )
            </when>
            <when test='type == "W"'>
                DATE_FORMAT( v.pub_date, '%y年%v周' )
            </when>
            <when test='type == "M"'>
                DATE_FORMAT( v.pub_date, '%y年%m月' )
            </when>
        </choose>
        Time,
        sum(v.play / v.game_count) AllPlay,
        sum(IF(v.dssq, 0, v.play / v.game_count)) Play,
        count(1) AllCount,
        sum(IF(v.dssq, 0, 1)) Count
        FROM v_video v
        WHERE instr(v.game_id, #{gameId}) > 0
        AND v.pub_date BETWEEN #{startDate} AND #{endDate}
        <choose>
            <when test='type == "D"'>
                GROUP BY DATE_FORMAT( v.pub_date, '%m月%d日' )
                ORDER BY DATE_FORMAT( v.pub_date, '%m月%d日' )
            </when>
            <when test='type == "W"'>
                GROUP BY DATE_FORMAT( v.pub_date, '%y年%v周' )
                ORDER BY DATE_FORMAT( v.pub_date, '%y年%v周' )
            </when>
            <when test='type == "M"'>
                GROUP BY DATE_FORMAT( v.pub_date, '%y年%m月' )
                ORDER BY DATE_FORMAT( v.pub_date, '%y年%m月' )
            </when>
        </choose>
    </select>
</mapper>